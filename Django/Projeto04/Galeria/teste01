'##Temperatura Baixa no Fancoil de acordo com SP apresentado"" 
'Está lógica Suporta os seguintes atributos: 
' CAG = comando(Habilita CAG) ----existe um dly para o tempo em que a CAG esta ligada
'FC comando/estado --- existe um segundo delay que so começa a ser contado apos o dly da CAG
'temperatura valor, SPValor, referencia  --- compara o valor da temp do fancoil com o sptemp - a referencia
'ALARME = (valor < (SPValor - me.referenciaAlarme)) and ((comando == True) OR (estado == True)) and (CAGligada == true)
 
'logmessage("-----INICIO LOGICA----"); 
 
'Declaração das variaveis 
dim i as integer; 
dim j as integer; 
dim sTipo as String; 
dim xTipo as indirect; 
dim sValor as String; 
dim xValor as indirect; 
dim byPass as String; 
dim sMntTag as String; 
dim xMntTag as indirect; 
dim pos[10] as Integer;'Array de 10 posições 
dim sPTag as String; 
dim xPTag as indirect; 
dim bMorta as float; 
dim lMax as float; 
dim ponto as integer; 
dim atributo as string; 
dim objeto as string; 
Dim mntAlm as Boolean; 
Dim cond1 as float; 
Dim cond2 as float; 
Dim condF as Boolean; 
Dim offGeral as Boolean; 
Dim contOffline as integer; 
Dim contAtributo as integer; 
dim contLogica as integer; 
dim contCAGLigada as integer; 
Dim condCAG as Boolean; 
dim contOfflineCAG as integer; 
dim contFCLigado as integer;  
Dim condFC as Boolean; 
dim contOfflineFC as integer; 
Dim byPassAtributos as integer; 
dim atributoID as integer; 'numero do atributo na TAG 
dim cortaObjeto as string; 
dim cortaObjeto2 as string; 
dim montaCortaObjeto as string; 
dim qtdObjetos as Integer; 
Dim contValor as integer; 
Dim condValor as integer; 
Dim schEstado as integer; 
Dim contOfflineValor as integer; 
Dim contSPValor as integer; 
Dim condSPValor as integer; 
Dim CAGligada as Boolean; 
Dim statusFC as Boolean; 
Dim condschEstado2 as Boolean; 
Dim contOfflineSPValor as integer; 
Dim contOfflineSchEstado as integer; 
Dim tempValor as float; 
Dim spTempValor as float; 
dim condHabCAG as boolean; 
dim condschEstado as boolean; 
dim equipamento as string; 
Dim contCAG as Boolean;
 
'Setando valores na variavel 
contOfflineSchEstado = 0;
CAGligada = false;
statusFC = false;
contLogica = 0; 
tempValor = 0; 
spTempValor = 0; 
condSchEstado = 0; 
contOfflineCAG = 0;
condCAG = true; 
contCAG = false;
condFC = true;
 
'logmessage("Inicio"); 
 
if (me.alm == False) then 
	qtdObjetos = 0; 
	me.infoLogica = ""; 
	me.montaInfoLogica = ""; 
	montaCortaObjeto = ""; 
	cortaObjeto = ""; 
	cortaObjeto2 = ""; 
	me.detalheMotivo = ""; 
	me.infoLogicaObs = "";	 
endif; 
 
for i=1 to 100 Step 1	'Varre todas as Tags para realizar todas as funções 
	'logmessage("Atributo["+i+"]= "+me.rTags[i]); 
	if (me.rTags[i] <> "") then	'Verifica se a lista está vazia 
		ponto = StringInString(me.rTags[i],".", 1, 0);	'Indica a posição do ponto 
		'logmessage("Ponto: "+ponto); 
		objeto = StringLeft(me.rTags[i],ponto - 1);	'corta o nome do objeto 
		'logmessage("objeto: "+objeto); 
		atributo = StringMid(me.rTags[i],ponto+1,StringLen(me.rTags[i]) - ponto); 	'corta o atributo 
		'logmessage("atributo: "+atributo); 
		sTipo = me.rTags[i]+".Type"; 'Define a string do Tipo de Tag 
		'logmessage("Tipo: "+sTipo);	 
		xTipo.BindTo(sTipo);	'Realiza o apontamento indireto TipoTag 
		'logmessage("xTipo: "+xTipo); 
		 
		'##Procura atributo## 
		for j=1 to 100 Step 1 
			sValor = objeto+".atributos["+j+"]"; 
			'logmessage("Atributo: "+sValor); 
			xValor.BindTo(sValor); 
			'logmessage("Atributo VAlor: "+xValor); 
			'logmessage("Atributo VAlor2: "+atributo); 
			if (xValor <> "") then 
				if (StringCompareNoCase(xValor, atributo) == 0) then	 
					sValor = objeto+".vAtributos["+j+"]";			'String para o valor do ponto 
					'logmessage("Valor: "+sValor); 
					atributoID = j; 
					j = 100; 'Sai do For 
				elseif (j == 100) then 
					me.almDev2 = true; 
				endif; 
			else 
				j = 100; 'Sai do For 
				me.almDev2 = true; 
			endif; 
		next; 
		'logmessage("me.almDev2: "+me.almDev2); 
		'logmessage("atributoID: "+atributoID); 
		sMntTag = objeto+".mntTag["+atributoID+"]";	'String para o ByPass do ponto 
		'logmessage("SmntTag: "+sMntTag); 
		xMntTag.BindTo(sMntTag);	'Realiza o apontamento indireto qualidade da TAg 
		'logmessage("xByPass MntTAg: "+xMntTag); 
		byPass = StringMid(xMntTag,15,1);	'ByPass do ponto 
		'logmessage("Qualidade: "+byPass); 
		xValor.BindTo(sValor);		'Realiza o apontamento indireto valor da Tag 
		'logmessage("xValor: "+xValor); 
 
		if(me.equipamento <> "") then  
			equipamento = "do "+me.equipamento; 
		elseif(StringInString(objeto,"_SELF",1,0)<> 0) then 
			equipamento = "do Self"; 
		elseif(StringInString(objeto,"_UC",1,0)<> 0) then 
			equipamento = "da Unidade Condensadora"; 
		else 
			equipamento = "do Fancoil"; 
		endif; 
			 
		'Acha Comando 
		IF ((StringInString(atributo,"comando",1,0)<> 0) and (StringInString(objeto,"CAG_Hab",1,0) <> 0)) then 
			cortaObjeto = StringRight(objeto, 2);	'corta os dois ultimos caracteres do Objeto. 		 
			'logmessage("Achou Comando!"); 
			contCAG = True;	
			if (byPass == "0") then 
				'logmessage("Qualidade BOA Comando!"); 
				condCAG = xValor; 	
			else	 
				'logmessage("Qualidade RUIM Comando!: "); 
				contOfflineCAG = contOfflineCAG +1; 
			Endif; 
			 
			IF (me.alm == False) and (xValor) then 
				if (me.infoLogicaObs == "") then 'Monta o InfoLogicaObs 
					me.infoLogicaObs = "Comando de habilita CAG "+cortaObjeto+" = "+objeto+"."+atributo;  
				Else 
					me.infoLogicaObs = me.infoLogicaObs+"Comando de habilita CAG "+cortaObjeto+" = "+objeto+"."+atributo;  
				Endif;	 
			Endif;	 	 
		'Acha estado 
		elseIF ((StringInString(atributo,"estado",1,0)<> 0) or (StringInString(atributo,"comando",1,0)<> 0) and (StringInString(objeto,"_FC0",1,0)<> 0)) and (StringInString(atributo,"schEstado",1,0)== 0)then 
			cortaObjeto2 = StringRight(objeto, 2);	'corta os dois ultimos caracteres do Objeto. 
			if (byPass == "0") then 
				'logmessage("Qualidade BOA Estado!"); 
				condFC = xValor; 				 
			else	 
				'logmessage("Qualidade RUIM Estado!: "); 
				contOfflineFC = contOfflineFC +1; 
			Endif;	 
			
			IF (me.alm == False) and (xValor) then 
				if (me.infoLogicaObs == "") then 'Monta o InfoLogicaObs 
					me.infoLogicaObs = "Estado "+equipamento+" "+cortaObjeto2+" = "+objeto+"."+atributo;  
				Else 
					me.infoLogicaObs = me.infoLogicaObs+"Estado da entalpia "+cortaObjeto2+" = "+objeto+"."+atributo;  
				Endif;	 
			Endif; 
			 
		'ACHA SCHCMD 
		elseIF (StringInString(atributo,"schEstado",1,0)<> 0) then 
			cortaObjeto2 = StringMid(objeto,14,2);	'corta os dois ultimos caracteres do Objeto. 
			if (byPass == "0") then 
				condschEstado = xValor;  
			else	 
				'logmessage("Qualidade RUIM schEstado!: "); 
				contOfflineSchEstado = contOfflineSchEstado +1; 
			Endif;	 
			IF (me.alm == False) and (xValor) then 
				if (me.infoLogicaObs == "") then 'Monta o InfoLogicaObs 
					me.infoLogicaObs = "Estado "+equipamento+" "+cortaObjeto2+" = "+objeto+"."+atributo;  
				Else 
					me.infoLogicaObs = me.infoLogicaObs+"Estado da entalpia "+cortaObjeto2+" = "+objeto+"."+atributo;  
				Endif;	 
			Endif; 
			 
		'Acha Temperatura e setPoint 
		elseif (StringInString(atributo,"tempIns",1,0)<> 0) then 
			If (StringCompareNoCase("tempIns",atributo) == 0) then 
				tempValor = xValor; 
				cortaObjeto = StringRight(objeto, 2);	'corta os dois ultimos caracteres do Objeto. 
				contValor = contValor + 1; 
				'logmessage("byPass : "+byPass ); 
				if (byPass == "0") then 
					'logmessage("Qualidade BOA Valor!"); 
					condValor = condValor + 1; 
				else	 
					'logmessage("Qualidade RUIM Valor!: "); 
					contOfflineValor = contOfflineValor +1; 
				Endif;	 
				IF (me.alm == False) then 
					if (me.infoLogicaObs == "") then 'Monta o InfoLogicaObs 
						me.infoLogicaObs = "Temperatura "+equipamento+" "+cortaObjeto+" = "+objeto+"."+atributo;  
					Else 
						me.infoLogicaObs = me.infoLogicaObs+"Temperatura "+equipamento+" "+cortaObjeto+" = "+objeto+"."+atributo;  
					Endif;	 
				Endif; 
			endif; 
		'Acha setPoint 
		elseif (StringInString(atributo,"tempRet",1,0)<> 0) then 
			If (StringCompareNoCase("tempRet",atributo) == 0) then 
				tempValor = xValor; 
				cortaObjeto = StringRight(objeto, 2);	'corta os dois ultimos caracteres do Objeto. 
				contValor = contValor + 1; 
				'logmessage("byPass : "+byPass ); 
				if (byPass == "0") then 
					'logmessage("Qualidade BOA Valor!"); 
					condValor = condValor + 1; 
				else	 
					'logmessage("Qualidade RUIM Valor!: "); 
					contOfflineValor = contOfflineValor +1; 
				Endif;	 
				IF (me.alm == False) then 
					if (me.infoLogicaObs == "") then 'Monta o InfoLogicaObs 
						me.infoLogicaObs = "Temperatura "+equipamento+" "+cortaObjeto+" = "+objeto+"."+atributo;  
					Else 
						me.infoLogicaObs = me.infoLogicaObs+"Temperatura "+equipamento+" "+cortaObjeto+" = "+objeto+"."+atributo;  
					Endif;	 
				Endif; 
			endif;	 
		elseif (StringInString(atributo,"SPTemp",1,0)<> 0) then 
			If StringCompareNoCase("SPTemp",atributo) == 0 then 
				spTempValor = xValor;			 
				cortaObjeto = StringRight(objeto, 2);	'corta os dois ultimos caracteres do Objeto. 
				contSPValor = contSPValor + 1; 
					byPass = 0; 
				if (byPass == "0") then 
					'logmessage("Qualidade BOA SPValor!"); 
					condSPValor = condSPValor + 1; 
				else	 
					'logmessage("Qualidade RUIM SPValor!: "); 
					contOfflineSPValor = contOfflineSPValor +1; 
				Endif;	 
				IF (me.alm == False) then 
					if (me.infoLogicaObs == "") then 'Monta o InfoLogicaObs 
						me.infoLogicaObs = "setPoint de temperatura "+equipamento+" "+cortaObjeto+" = "+objeto+"."+atributo;  
					Else 
						me.infoLogicaObs = me.infoLogicaObs+"setPoint de temperatura "+equipamento+" "+cortaObjeto+" = "+objeto+"."+atributo;  
					Endif;	 
				Endif; 
			Endif;		 
		endif;				 
	else 
		if (i == 1) then 
			me.almDev4 = True; 
		endif; 
		'logmessage("SAI Do FOR!"); 
		i = 100;	'Sai do For 
	endif; 
next; 


'verifica tempo cag ligado 
if (contCAG) then
	if (condCAG) and (contOfflineCAG == 0) then 
		if(me.contCAGLigada < me.delayInicialCag) then 
			'logmessage("Incrementando contCAGLigada"); 
			me.contCAGLigada = me.contCAGLigada + 1; 
		else
			'logmessage("carga termica da CAG concluida");
			CAGligada = true;
			' verifica tempo do fancoil ligado
			if (condFC) or (condschEstado) then 
				if(me.contFCLigado < me.delayInicialFC) then 
					me.contFCLigado = me.contFCLigado + 1; 	 
				else
					'logmessage("carga termica do Fancoil concluida");
					statusFC = true; 
				endIf; 
			else 
				me.contFCLigado = 0; 
				statusFC = false; 
			Endif;
		endIf;	 
	else
		'logmessage("zerando contCAGLigada"); 
		me.contCAGLigada = 0; 
		CAGligada = false; 
	endIf;	 
else
	if (contOfflineFC == 0) then
		if (condFC) or (condschEstado) then 
			if(me.contFCLigado < me.delayInicialFC) then 
				me.contFCLigado = me.contFCLigado + 1; 	 
			else
				'logmessage("carga termica do Fancoil concluida");
				statusFC = true; 
			endIf; 
		else 
			me.contFCLigado = 0; 
			statusFC = false; 
		Endif;
	Endif;
endIf;

'logmessage("Verificação de atributos:");
'logmessage("condCAG: "+condCAG);
'logmessage("contOfflineCAG: "+ contOfflineCAG);
'logmessage("condFC: "+condFC);
'logmessage("contOfflineFC: "+ contOfflineFC);
'logmessage("condschEstado: "+condschEstado);
'logmessage("contOfflineSchEstado: "+ contOfflineSchEstado);
'logmessage("tempValor: "+tempValor);
'logmessage("spTempValor: "+ spTempValor);
'logmessage("---------------------------------------------");
'logmessage("statusFC: "+statusFC);
'logmessage("CAGligada: "+CAGligada);

'Lógica					 --------------------------------------------------------------------------
IF (tempValor <> 0) AND (spTempValor <> 0) then 
	'logmessage("verifica valores de temp e sptemp"); 
	if(CAGligada) then  
		IF ((tempValor < (spTempValor - me.referenciaAlarme)) and statusFC) then				 
			'logmessage("condição habCag!"); 
			me.condDisparo = true;					 
			'logmessage("me.condDisparo: " + me.condDisparo); 
		elseif ((tempValor <= spTempValor)and (statusFC)) then	'Verifica se a tag normalizou 
			me.condDisparo = False; 
			'logmessage("Normal!"); 
		endif; 
	else
		 IF((tempValor < (spTempValor - me.referenciaAlarme)) and statusFC) then				 
			'logmessage("condição sem habCag!"); 
			me.condDisparo = true;					 
			'logmessage("me.condDisparo: " + me.condDisparo); 
		elseif (tempValor <= spTempValor) then		'Verifica se a tag normalizou 
			me.condDisparo = False; 
			'logmessage("Normal!"); 
		endif; 
	endIf; 
	contLogica = me.condDisparo;'Verifica se há algum alarme 
	if (me.alm == False) AND (contLogica > 0) AND (me.condDisparo == True) then 
		if (me.montaInfoLogica == "") then 
			me.montaInfoLogica = "A temperatura "+equipamento+" "+cortaObjeto2+", cujo o valor atual é de "+tempValor+"ºC, está abaixo do setPoint de "+spTempValor+"ºC - "+me.referenciaAlarme+"ºC por mais de "+(me.dlyAlm / 4)+" minutos.";  
		Else 
			me.montaInfoLogica = me.montaInfoLogica+"A temperatura "+equipamento+" "+cortaObjeto2+", cujo o valor atual é de "+tempValor+"ºC, está abaixo do setPoint de "+spTempValor+"ºC - "+me.referenciaAlarme+"ºC por mais de "+(me.dlyAlm / 4)+" minutos."; 							 
		Endif; 
	Endif;
Endif;	
'logmessage("Inicia a Verificação a logica");
'logmessage("me.condDisparo: "+me.condDisparo);
'logmessage("se tempValor: "+ tempValor+" for menor do que:"+spTempValor+"menos"+me.referenciaAlarme+"entao esta em condição de disparo");

'logmessage("antes é visto se statusFC: "+ statusFC);
'logmessage("condschEstado2: "+ condschEstado2); 

'Disparo

'Verifica se todas as tags estão Fora 
if ((contOfflineCAG == 0) AND (contOfflineValor == 0) AND (contOfflineSPValor == 0) and ((contOfflineSchEstado == 0) OR (contOfflineFC == 0))) then 
	'logmessage("todos os pontos com leitura boa?"); 
	if (me.byPassLogica <> 1)then	'##ByPass Parcial## 
		me.byPassLogica = 1; 
		me.filaUpdate = me.filaUpdate + 1; 
	elseif (me.byPassLogica <> 0)then '##Remove ByPass## 
		me.byPassLogica = 0; 
		me.filaUpdate = me.filaUpdate + 1; 
	endif; 
	'##Verificação de Alarme##	 
		'logmessage("ultima camada de verificação"); 
	if(me.condDisparo == true) then 
		'logmessage("alarme!"); 
		me.contNor = 0; 
		if (me.contAlm < me.dlyAlm) then 
			me.contAlm = me.contAlm + 1; 
		else 
			me.infoLogica = "Este alarme é gerado caso a temperatura de saída "+equipamento+" "+cortaObjeto2+" atinja um valor baixo do limite enquanto a CAG estiver ligada."+me.montaInfoLogica; 
			me.detalheMotivo = "A temperatura de saída "+equipamento+" "+cortaObjeto2+" estava abaixo do limite.Solicitamos ao Sr.[Pessoa Contatada] (Empresa [Empresa]) que certificasse visualmente "+cortaObjeto2+".Foi constatado que o alarme era [real/falso], causado por [motivo]."; 
			me.alm = True;		 
		endif; 
	else			'Remove Alarme 
		'logmessage("NÃO ESTÁ EM ALARME!"); 
		me.contAlm = 0; 
		if (me.contNor < me.dlyNor) then 
			me.contNor = me.contNor + 1; 
		else 
			me.alm = False; 
		endif; 
	endif; 
else 
	if (me.byPassLogica <> 2)then '##By Pass Total 
		me.byPassLogica = 2; 
		me.filaUpdate = me.filaUpdate + 1; 
	endif; 
endif; 
 
'logmessage("------FIM LOGICA------");